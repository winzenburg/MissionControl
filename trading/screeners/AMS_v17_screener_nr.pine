//@version=6
indicator("AMS v17 Screener - Non-Repainting (nr)", overlay=false)
// Composite momentum, HTF bias (confirmed), volume trend/spike proxy, structure, correlation, regime

// ===== Inputs =====
shortROC = input.int(21 , "Short ROC", group="Momentum")
medROC   = input.int(63 , "Med ROC",   group="Momentum")
longROC  = input.int(126, "Long ROC",  group="Momentum")
minScore = input.float(0.05, "Min CompScore", group="Scoring")

rsiLen = input.int(14 , "RSI Len", group="RSI")
minRSI = input.int(45 , "Min RSI", group="RSI")
maxRSI = input.int(75 , "Max RSI", group="RSI")

wWeekly  = input.float(0.3 , "Weekly weight",  step=0.05, group="HTF")
wMonthly = input.float(0.2 , "Monthly weight", step=0.05, group="HTF")
useConfirmed = input.bool(true, "Use Confirmed HTF Bars", group="HTF")

volLook   = input.int(20 , "Vol trend len", group="Volume")
volSpikeK = input.float(2.0 , "SpikeÃ—Avg",  group="Volume")

pivotLen = input.int(5 , "Pivot strength", group="Structure")

corrLen = input.int(20 , "Corr len", group="Correlation")
corrMax = input.float(0.8 , "|Corr| max", group="Correlation")

// ===== Momentum =====
rocS = ta.roc(close, shortROC)
rocM = ta.roc(close, medROC)
rocL = ta.roc(close, longROC)
compScore = 0.2*rocS + 0.3*rocM + 0.5*rocL

// ===== RSI / Dual Momentum =====
myRSI  = ta.rsi(close, rsiLen)
absMom = close > close[longROC]
relMom = myRSI > 50

// ===== HTF Bias (confirmed prior bar) =====
get_htf_roc(tf, lb, confirmed) =>
    request.security(syminfo.tickerid, tf, confirmed ? ta.roc(close, lb)[1] : ta.roc(close, lb), lookahead=barmerge.lookahead_off)

weeklyROC  = get_htf_roc("W", 13, useConfirmed)
monthlyROC = get_htf_roc("M",  6, useConfirmed)

squash(x) => (math.exp(2*(x/10)) - 1) / (math.exp(2*(x/10)) + 1)
htfBias = wWeekly * squash(weeklyROC) + wMonthly * squash(monthlyROC)

// ===== Volume Trend & Spike =====
avgVol  = ta.sma(volume, volLook)
volUp   = volume > avgVol * volSpikeK ? 1 : 0
volTrend= ta.sma(volume, volLook) > ta.sma(volume, volLook*2) ? 1 : 0
volAdj  = 0.5*volTrend + 0.5*volUp

// ===== Structure Quality =====
ph = ta.pivothigh(high, pivotLen, pivotLen)
pl = ta.pivotlow (low , pivotLen, pivotLen)
structPts   = (not na(ph) ? 1 : 0) + (not na(pl) ? 1 : 0)
structScore = ta.sma(structPts, 50)/2

// ===== Correlation Guard =====
spx  = request.security("SPY","D",close)
corr = ta.correlation(close, spx, corrLen)
lowCorr = math.abs(corr) < corrMax

// ===== Composite Score =====
scoreRaw = compScore/0.08
scoreRaw := math.min(math.max(scoreRaw,0),1)
htfAdj   = (htfBias+1)/2
structAdj= structScore
final  = (0.4*scoreRaw + 0.2*htfAdj + 0.2*volAdj + 0.2*structAdj)

// ===== Regime =====
bbWidth = ta.stdev(close, 20)*2
squeeze = bbWidth/close < 0.01
breakout= ta.highest(close,10)==close or ta.lowest(close,10)==close
regime  = squeeze?0:breakout?2:1

// ===== Pass Criteria =====
passScore = final > minScore
passRSI   = myRSI>=minRSI and myRSI<=maxRSI
passAll   = passScore and passRSI and absMom and relMom and lowCorr

tier = final>=0.8?3:final>=0.6?2:1

// ===== Plots (screener columns) =====
plot(passAll?1:0,  "Signal",   display=display.none)
plot(final,       "CompScore", display=display.none)
plot(myRSI,       "RSI",       display=display.none)
plot(htfBias,     "HTFBias",   display=display.none)
plot(volTrend,    "VolTrend",  display=display.none)
plot(structAdj,   "StructQ",   display=display.none)
plot(math.abs(corr), "AbsCorr", display=display.none)
plot(regime,      "Regime",    display=display.none)
plot(tier,        "Tier",      display=display.none)

// ===== Alert =====
alertcondition(passAll and not passAll[1], "New Match", "AMS v17 (nr): New asset passes criteria")
