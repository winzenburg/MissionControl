#!/usr/bin/env node

/**
 * Morning Task Generation (9:00 AM MT)
 * 
 * Reviews goals and proactively generates 1-2 new tasks
 * Adds them to tasks/backlog/
 * 
 * Scheduled via cron: 0 9 * * * (MST/MDT)
 */

import fs from 'fs';
import path from 'path';

const BACKLOG_PATH = './tasks/backlog';
const LOG_FILE = './logs/morning-tasks.log';

function log(message) {
  const timestamp = new Date().toISOString();
  console.log(`[${timestamp}] ${message}`);
  if (!fs.existsSync('./logs')) fs.mkdirSync('./logs', { recursive: true });
  fs.appendFileSync(LOG_FILE, `[${timestamp}] ${message}\n`);
}

function generateTaskId() {
  const timestamp = Date.now();
  return `task-${timestamp}`;
}

function createTaskFile(taskId, title, description, goal, priority, dueDate) {
  const content = `# ${title}

**ID:** ${taskId}  
**Goal:** ${goal}  
**Priority:** ${priority}  
**Created:** ${new Date().toISOString().split('T')[0]}  
**Due:** ${dueDate}  
**Status:** Backlog  

## Description

${description}

## Context

Generated by proactive morning task review.

## Next Actions

- [ ] Review and plan execution
- [ ] Break down into subtasks if needed
- [ ] Move to In Progress when ready
`;

  const filename = `${taskId}-${title.toLowerCase().replace(/[^a-z0-9]/g, '-')}.md`;
  const filepath = path.join(BACKLOG_PATH, filename);

  fs.writeFileSync(filepath, content);
  return { filename, filepath };
}

async function generateProactiveTasks() {
  log('===== Morning Task Generation Start =====');

  const today = new Date();
  const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);
  const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

  // Placeholder task suggestions based on known goals
  // These will be replaced with AI-generated tasks after brain dump

  const suggestedTasks = [
    {
      title: 'Review Kinlet Week 1 Progress',
      description: 'Check signup numbers, referral rate, and engagement metrics. Identify what\'s working and adjust strategy if needed.',
      goal: 'Kinlet GTM',
      priority: 'High',
      due: today.toISOString().split('T')[0]
    },
    {
      title: 'Monitor First Trading Day Results',
      description: 'Review first day of live trading: entry quality, P&L, system stability, any issues with webhooks or alerts.',
      goal: 'Swing Trading',
      priority: 'High',
      due: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
    }
  ];

  // Create 1-2 tasks
  const tasksToCreate = suggestedTasks.slice(0, Math.random() > 0.5 ? 1 : 2);

  for (const taskDef of tasksToCreate) {
    try {
      const taskId = generateTaskId();
      const result = createTaskFile(
        taskId,
        taskDef.title,
        taskDef.description,
        taskDef.goal,
        taskDef.priority,
        taskDef.due
      );

      log(`✓ Created task: ${taskDef.title}`);
    } catch (error) {
      log(`✗ Error creating task: ${error.message}`);
    }
  }

  // Re-index tasks
  try {
    const { execSync } = await import('child_process');
    execSync('node scripts/index-tasks.mjs', { cwd: '.' });
    log('✓ Reindexed task list');
  } catch (error) {
    log(`⚠ Error reindexing: ${error.message}`);
  }

  log('===== Morning Task Generation Complete =====');
}

generateProactiveTasks();
